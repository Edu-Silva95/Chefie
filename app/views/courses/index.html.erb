  <div class="courses-page-body">
    <header class="top-bar">
      <%= link_to dashboard_index_path, class: "custom-back-btn-link" do %>
        <span class="custom-btn-inner">‚Üê Back</span>
      <% end %>

     <div class="top-bar__inner">
      <div class="top-bar__center">
        <img src="/assets/avatar.png" alt="Logo" class="top-bar__logo">
        <div class="top-bar__text">
          <span class="top-bar__title">My Courses & Feed</span>
          <p class="top-bar__subtitle">Here you can share videos of recipes and talk to other people!</p>
        </div>
      </div>
     </div>
    </header>

    <div class="courses-page">
        <div class="post-box">
          <div class="post-box__header">
            <% if current_user.avatar.attached? %>
              <%= image_tag current_user.avatar.variant(resize_to_fill: [40, 40]), class: "user-avatar-img" %>
            <% else %>
              <%= image_tag "avatar.png", class: "user-avatar-img" %>
            <% end %>

            <%= form_with model: Post.new, url: posts_path, local: true, html: { class: "post-form" } do |f| %>
              <%= f.text_area :content,
                rows: 3,
                required: true,
                placeholder: "What's on your mind?",
                class: "post-textarea" %>

              <div class="post-box__actions">
                <button type="button" id="toggle-course-form" class="action-btn">üìπ Course</button>
                <%= f.submit 'Post', class: 'post-submit' %>
              </div>
            <% end %>
          </div>

          <!-- Hidden Course Form -->
          <div id="course-form" class="course-form hidden">
            <%= form_with model: Course.new, url: courses_path, local: true do |f| %>
              <div class="form-group">
                <%= f.label :name %>
                <%= f.text_field :name, required: true, placeholder: "Course Title" %>
              </div>
              <div class="form-group">
                <%= f.label :youtube_url, 'YouTube URL' %>
                <%= f.text_field :youtube_url,
                  required: true,
                  placeholder: "https://youtube.com/..." %>
              </div>
              <div class="form-group">
                <%= f.label :description %>
                <%= f.text_area :description,
                  rows: 3,
                  required: true,
                  placeholder: "Course description..." %>
              </div>
              <%= f.submit 'Add Course', class: 'course-submit' %>
            <% end %>
          </div>
        </div>
      <div class="feed-wrapper">
        <!-- Feed Items -->
        <div class="feed">
          <% combined = (@posts + @courses).sort_by(&:created_at).reverse %>
          <% if combined.any? %>
            <% combined.each do |item| %>
              <div class="feed-item">
                <div class="item-header" style="display: flex; align-items: center; gap: 0.5rem;">
                  <% if item.respond_to?(:user) && item.user.present? %>
                    <% if item.user.avatar.attached? %>
                      <%= image_tag item.user.avatar.variant(resize_to_fill: [32, 32]), class: "user-avatar-img" %>
                    <% else %>
                      <%= image_tag "avatar.png", class: "user-avatar-img" %>
                    <% end %>
                    <strong><%= item.user.username %></strong>
                  <% else %>
                    <strong><%= item.name %></strong>
                  <% end %>
                  <span class="timestamp" style="margin-left: auto;"><%= item.created_at.strftime('%b %d, %Y at %H:%M') %></span>

                  <!-- Ellipsis Menu (Dropdown) -->
                  <div class="dropdown dropdown-feed">
                    <button class="ellipsis-btn">...</button>
                    <div class="dropdown-content dropdown-content-feed">
                      <button class="dropdown-item report-btn" data-post-id="<%= item.id %>">Report</button>

                      <% if item.user == current_user %>
                        <%= link_to 'Delete',
                          (item.is_a?(Post) ? post_path(item) : course_path(item)),
                          method: :delete,
                          data: { confirm: item.is_a?(Post) ? 'Are you sure you want to delete this post?' : 'Are you sure you want to delete this course?' },
                          class: 'dropdown-item delete-item' %>
                      <% end %>

                      <!-- Share triggers popup -->
                      <button class="dropdown-item open-share-modal"
                              data-post-id="<%= item.id %>"
                              data-url="<%= item.is_a?(Post) ? post_url(item) : course_url(item) %>"
                              data-content="<%= h(item.try(:content).presence || item.try(:description).to_s.truncate(100)) %>">
                        Share
                      </button>
                    </div>
                  </div>
                </div>
                <div class="item-content">
                  <% if item.is_a?(Post) %>
                    <%= simple_format(h(item.content)) %>
                  <% else %>
                    <% if item.youtube_url.present? %>
                      <% vid = extract_youtube_id(item.youtube_url) %>
                      <% if vid.present? %>
                        <div class="video-embed">
                          <iframe width="100%" height="315"
                                  src="https://www.youtube.com/embed/<%= vid %>"
                                  frameborder="0"
                                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                  allowfullscreen>
                          </iframe>
                        </div>
                      <% end %>
                    <% elsif item.image.attached? %>
                      <%= image_tag item.image, class: 'feed-image', alt: item.name %>
                    <% end %>
                    <h3 class="course-title"><%= item.name %></h3>
                    <p class="course-description"><%= truncate(item.description, length: 150) %></p>
                  <% end %>
                </div>
                <div class="item-actions" style="display: flex; align-items: center; gap: 0.5rem;">
                  <% if item.is_a?(Post) %>
                  <% like_count = item.likes_count %>
                  <% user_liked = current_user && item.likes.exists?(user: current_user) %>

                  <div class="like-group" style="display: flex; align-items: center; gap: 0.3rem;">
                    <% if user_liked %>
                      <%= link_to '‚ù§Ô∏è', unlike_post_path(item), method: :get, class: "like-button heart liked" %>
                    <% else %>
                      <%= link_to 'ü§ç', like_post_path(item), method: :get, class: "like-button heart" %>
                    <% end %>

                    <% if like_count > 0 %>
                      <div id="likes-count-<%= item.id %>" class="likes-display">
                        <% if user_liked %>
                          You like this post
                        <% else %>
                          <% if like_count == 1 %>
                            <%= pluralize(like_count, 'person') %> likes this post
                          <% else %>
                            <%= pluralize(like_count, 'person') %> like<%= 's' if like_count > 1 %> this post
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                  <% elsif item.is_a?(Course) %>
                    <% like_count = item.likes_count %>
                    <% user_liked = current_user && item.likes.exists?(user: current_user) %>

                    <div class="like-group" style="display: flex; align-items: center; gap: 0.3rem;">
                      <% if user_liked %>
                        <%= link_to '‚ù§Ô∏è', unlike_course_path(item), method: :get, class: "like-button heart liked" %>
                      <% else %>
                        <%= link_to 'ü§ç', like_course_path(item), method: :get, class: "like-button heart" %>
                      <% end %>

                      <% if like_count > 0 %>
                        <div id="likes-count-<%= item.id %>" class="likes-display">
                          <% if user_liked %>
                            You<%= " and #{like_count - 1} other#{'s' if like_count - 1 != 1}" if like_count > 1 %> like this
                          <% else %>
                            <%= pluralize(like_count, 'person') %> like<%= 's' if like_count == 1 %> this
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="feed-item empty-state">
              No posts or courses yet.
            </div>
          <% end %>
        </div>
      </div>

      <section class="all-courses-section">
      <div class="section-header">
        <div>
          <h2 class="section-title">Courses</h2>
          <h3 class="section-subtitle">Videos that teach you something new!</h3>
        </div>
        <a href="<%= all_courses_path %>" class="show-all-link">Show All <span class="arrow">‚Üí</span></a>
      </div>
        <% if @courses.any? %>
          <div class="courses-container">
            <div class="courses-grid">
              <% @courses.limit(3).each do |course| %>
                <div class="course-card">
                  <% if (vid = extract_youtube_id(course.youtube_url)).present? %>
                    <div class="course-card__video">
                      <iframe width="100%" height="200" src="https://www.youtube.com/embed/<%= vid %>" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                  <% elsif course.image.attached? %>
                    <%= image_tag course.image.variant(resize_to_fill: [300, 200]), alt: course.name, class: "course-card__image" %>
                  <% end %>
                  <div class="course-card__body">
                    <h3 class="course-card__title"><%= course.name %></h3>
                    <p class="course-card__description"><%= truncate(course.description, length: 100) %></p>
                   <div class="courses-page__course-card-actions">
                <div class="courses-page__course-card-actions">
                  <%= link_to "View Course", course_path(course), class: "courses-page__course-card-view-btn" %>
                </div>
                <% if course.user == current_user %>
                  <div class="courses-page__course-card-delete-wrapper">
                    <%= button_to "√ó", course_path(course), method: :delete, data: { confirm: "Are you sure you want to delete this video?" }, class: "courses-page__course-card-delete-x" %>
                  </div>
                <% end %>
              </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <p class="empty-state">No courses available.</p>
        <% end %>
      </section>
    </div>
    <div class="back-to-top-wrapper">
      <button id="back-to-top-btn" class="back-to-top">‚Üë Back to Top</button>
    </div>

   <div id="share-modal" class="share-modal modal-hidden">
      <div class="share-modal__content">
        <span id="close-share-modal" class="share-modal__close">&times;</span>

       <div class="share-options">
        <a id="twitter-share" href="#" target="_blank" rel="noopener" aria-label="Share on X (Twitter)">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:24px; height:24px; vertical-align:middle; fill:#1DA1F2;">
            <title> X</title>
            <path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/>
          </svg>
          X
        </a>
        
        <a id="facebook-share" href="#" target="_blank" rel="noopener" class="share-option">
          <!-- Facebook SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#1877F2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 8px;">
            <path d="M22.675 0h-21.35C.6 0 0 .6 0 1.342v21.317C0 23.4.6 24 1.325 24H12.82v-9.294H9.692v-3.622h3.128V8.414c0-3.1 1.894-4.788 4.66-4.788 1.325 0 2.466.099 2.798.143v3.24h-1.92c-1.504 0-1.796.715-1.796 1.763v2.31h3.59l-.467 3.622h-3.123V24h6.116c.725 0 1.325-.6 1.325-1.342V1.342C24 .6 23.4 0 22.675 0z"/>
          </svg>
          Facebook
        </a>

        <button id="copy-share-link" class="share-option">
          <!-- You can add a copy icon SVG here if you want -->
          Copy Link
        </button>
      </div>
    </div>
</div>

<script>
  document.addEventListener('turbo:load', () => {
    const toggleBtn = document.getElementById('toggle-course-form');
    const courseForm = document.getElementById('course-form');
    const backToTopBtn = document.getElementById('back-to-top-btn');
    const shareModal = document.getElementById('share-modal');
    const twitterLink = document.getElementById('twitter-share');
    const facebookLink = document.getElementById('facebook-share');
    const copyBtn = document.getElementById('copy-share-link');
    const closeShareModal = document.getElementById('close-share-modal');

    // Toggle course form
    if (toggleBtn && courseForm) {
      toggleBtn.addEventListener('click', () => {
        courseForm.classList.toggle('hidden');
      });
    }

    // Dropdown ellipsis
    document.querySelectorAll('.ellipsis-btn').forEach(button => {
      button.addEventListener('click', event => {
        event.stopPropagation();
        button.nextElementSibling.classList.toggle('show');
      });
    });

    // Close dropdowns when clicking outside
    window.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-content').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
    });

    // Back to top
    if (backToTopBtn) {
      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // Share modal open (with fallback)
    document.querySelectorAll('.open-share-modal').forEach(button => {
      button.addEventListener('click', () => {
        const url = button.getAttribute('data-url');
        const text = button.getAttribute('data-content');

        console.log("Opening Share Modal with:", { url, text });

        twitterLink.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
        facebookLink.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
        copyBtn.setAttribute('data-url', url);

        // Show via class
        shareModal.classList.remove('modal-hidden');
        // FALLBACK: force it visible
        shareModal.style.display = 'flex';
      });
    });

    // Copy to clipboard
    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        const url = copyBtn.getAttribute('data-url');
        navigator.clipboard.writeText(url).then(() => {
          alert("Link copied to clipboard!");
        });
      });
    }

    // Close modal via X (with fallback)
    if (closeShareModal) {
      closeShareModal.addEventListener('click', () => {
        shareModal.classList.add('modal-hidden');
        // FALLBACK: hide inline display
        shareModal.style.display = 'none';
      });
    }

    // Close modal when clicking outside the box
    if (shareModal) {
      shareModal.addEventListener('click', e => {
        if (e.target === shareModal) {
          shareModal.classList.add('modal-hidden');
          shareModal.style.display = 'none';
        }
      });
    }
  });
</script>
